# ğŸ—ï¸ ç³»çµ±æ¶æ§‹æ–‡ä»¶

## ğŸ“Š æ•´é«”æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         LINE User                                â”‚
â”‚                    (å‚³é€è‚¡ç¥¨ä»£è™Ÿï¼š2330)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ Webhook
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Netlify Serverless                            â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         line-webhook.js (ä¸»è™•ç†å™¨)                      â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚  1. é©—è­‰ LINE Signature                                 â”‚    â”‚
â”‚  â”‚  2. æª¢æŸ¥ Reply Token å»é‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚    â”‚
â”‚  â”‚  3. è§£æè‚¡ç¥¨ä»£è™Ÿ                     â”‚                  â”‚    â”‚
â”‚  â”‚  4. æª¢æŸ¥å¿«å– (12å°æ™‚) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”          â”‚    â”‚
â”‚  â”‚  5. æŠ“å– FinMind è³‡æ–™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”       â”‚    â”‚
â”‚  â”‚  6. è¨ˆç®—æŠ€è¡“æŒ‡æ¨™                     â”‚      â”‚  â”‚       â”‚    â”‚
â”‚  â”‚  7. ç”Ÿæˆåœ–è¡¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”    â”‚    â”‚
â”‚  â”‚  8. å‘¼å« DeepSeek AI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”  â”‚    â”‚
â”‚  â”‚  9. å„²å­˜å¿«å–                         â”‚      â”‚  â”‚  â”‚ â”‚  â”‚    â”‚
â”‚  â”‚ 10. å›è¦† Flex Message                â”‚      â”‚  â”‚  â”‚ â”‚  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”¼â”€â”€â”˜    â”‚
â”‚                                          â”‚      â”‚  â”‚  â”‚ â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚      â”‚  â”‚  â”‚ â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚  â”‚ â”‚
                    â”‚                             â”‚  â”‚  â”‚ â”‚
                    â–¼                             â”‚  â”‚  â”‚ â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚  â”‚  â”‚ â”‚
         â”‚   Supabase DB       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ â”‚
         â”‚                     â”‚                     â”‚  â”‚ â”‚
         â”‚  â€¢ line_events      â”‚ (å»é‡è¡¨)            â”‚  â”‚ â”‚
         â”‚  â€¢ stock_cache      â”‚ (å¿«å–è¡¨)            â”‚  â”‚ â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚  â”‚ â”‚
                                                     â”‚  â”‚ â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
                    â”‚                                    â”‚ â”‚
                    â–¼                                    â”‚ â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚ â”‚
         â”‚   FinMind API       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
         â”‚                     â”‚                           â”‚
         â”‚  â€¢ TaiwanStockPrice â”‚ (è‚¡åƒ¹è³‡æ–™)                â”‚
         â”‚  â€¢ TaiwanStockInfo  â”‚ (è‚¡ç¥¨è³‡è¨Š)                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
                                                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                                       â”‚
                    â–¼                                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
         â”‚  Supabase Storage   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚                            â”‚
         â”‚  â€¢ stock-charts/    â”‚ (åœ–è¡¨ PNG)                 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
                                                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   DeepSeek API      â”‚
         â”‚                     â”‚
         â”‚  â€¢ æŠ€è¡“æŒ‡æ¨™åˆ†æ      â”‚
         â”‚  â€¢ æœªä¾†èµ°å‹¢é æ¸¬      â”‚
         â”‚  â€¢ æ”¯æ’å£“åŠ›ä½        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ è³‡æ–™æµç¨‹

### 1ï¸âƒ£ é¦–æ¬¡æŸ¥è©¢æµç¨‹ï¼ˆç„¡å¿«å–ï¼‰

```
User å‚³é€ "2330"
    â†“
LINE Webhook â†’ Netlify Function
    â†“
æª¢æŸ¥ Reply Token (line_events è¡¨)
    â†“ (æœªä½¿ç”¨é)
è¨˜éŒ„ Reply Token
    â†“
æª¢æŸ¥å¿«å– (stock_cache è¡¨)
    â†“ (ç„¡å¿«å–æˆ–å·²éæœŸ)
å‘¼å« FinMind API
    â†“ (å–å¾— 365 å¤©è³‡æ–™)
è¨ˆç®—æŠ€è¡“æŒ‡æ¨™ (KD, MACD, MA)
    â†“
ç”Ÿæˆåœ–è¡¨ (Chart.js)
    â†“
ä¸Šå‚³åœ–è¡¨åˆ° Supabase Storage
    â†“
å‘¼å« DeepSeek AI åˆ†æ
    â†“
çµ„è£ Flex Message
    â†“
å„²å­˜å¿«å– (stock_cache è¡¨)
    â†“
å›è¦† LINE User (replyMessage)
    â†“
å®Œæˆ (ç¸½è€—æ™‚ 15-25 ç§’)
```

### 2ï¸âƒ£ å¿«å–æŸ¥è©¢æµç¨‹ï¼ˆ12 å°æ™‚å…§ï¼‰

```
User å‚³é€ "2330"
    â†“
LINE Webhook â†’ Netlify Function
    â†“
æª¢æŸ¥ Reply Token (line_events è¡¨)
    â†“ (æœªä½¿ç”¨é)
è¨˜éŒ„ Reply Token
    â†“
æª¢æŸ¥å¿«å– (stock_cache è¡¨)
    â†“ (å‘½ä¸­å¿«å–ï¼)
å–å¾—å¿«å–è³‡æ–™ (åœ–è¡¨ URL + åˆ†æçµæœ)
    â†“
çµ„è£ Flex Message (æ¨™è¨»ã€Œå¿«å–ã€)
    â†“
å›è¦† LINE User (replyMessage)
    â†“
å®Œæˆ (ç¸½è€—æ™‚ 1-2 ç§’)
```

## ğŸ§© æ¨¡çµ„æ¶æ§‹

### Core Modules

```
functions/
â”œâ”€â”€ line-webhook.js          # ä¸»æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ é©—è­‰ LINE Signature
â”‚   â”œâ”€â”€ Reply Token å»é‡
â”‚   â”œâ”€â”€ è¨Šæ¯è·¯ç”±
â”‚   â””â”€â”€ Flex Message çµ„è£
â”‚
â”œâ”€â”€ supabase-client.js       # è³‡æ–™åº«å±¤
â”‚   â”œâ”€â”€ isReplyTokenUsed()   # æª¢æŸ¥å»é‡
â”‚   â”œâ”€â”€ recordReplyToken()   # è¨˜éŒ„ token
â”‚   â”œâ”€â”€ getStockCache()      # å–å¾—å¿«å–
â”‚   â””â”€â”€ saveStockCache()     # å„²å­˜å¿«å–
â”‚
â”œâ”€â”€ finmind.js               # è³‡æ–™ä¾†æºå±¤
â”‚   â”œâ”€â”€ fetchStockPrice()    # æŠ“å–è‚¡åƒ¹
â”‚   â”œâ”€â”€ fetchStockInfo()     # æŠ“å–è³‡è¨Š
â”‚   â””â”€â”€ isValidStockId()     # é©—è­‰ä»£è™Ÿ
â”‚
â”œâ”€â”€ indicators.js            # è¨ˆç®—å±¤
â”‚   â”œâ”€â”€ calculateKD()        # KD æŒ‡æ¨™
â”‚   â”œâ”€â”€ calculateMACD()      # MACD æŒ‡æ¨™
â”‚   â”œâ”€â”€ calculateMA()        # ç§»å‹•å¹³å‡
â”‚   â”œâ”€â”€ analyzeKD()          # KD åˆ†æ
â”‚   â””â”€â”€ analyzeMACDSignal()  # MACD åˆ†æ
â”‚
â”œâ”€â”€ generate-chart.js        # è¦–è¦ºåŒ–å±¤
â”‚   â”œâ”€â”€ renderLineChart()    # æŠ˜ç·šåœ–
â”‚   â”œâ”€â”€ renderMixedChart()   # æ··åˆåœ–
â”‚   â””â”€â”€ generateIndicatorChart() # ä¸»å‡½æ•¸
â”‚
â””â”€â”€ deepseek.js              # AI å±¤
    â””â”€â”€ analyzeWithDeepSeek() # AI åˆ†æ
```

## ğŸ” å®‰å…¨æ©Ÿåˆ¶

### 1. Webhook å»é‡æ©Ÿåˆ¶

**å•é¡Œ**ï¼šLINE Webhook å¯èƒ½å› ç¶²è·¯å•é¡Œé‡è¤‡è§¸ç™¼

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```javascript
// ä½¿ç”¨ Supabase line_events è¡¨è¨˜éŒ„ Reply Token
const isUsed = await isReplyTokenUsed(replyToken);
if (isUsed) {
  console.log('å·²è™•ç†éï¼Œå¿½ç•¥');
  return;
}
await recordReplyToken(replyToken);
```

**æ•ˆæœ**ï¼š
- âœ… é˜²æ­¢é‡è¤‡å›è¦†
- âœ… é˜²æ­¢ Reply Token é‡è¤‡ä½¿ç”¨éŒ¯èª¤
- âœ… è‡ªå‹•æ¸…ç† 7 å¤©å‰çš„èˆŠè¨˜éŒ„

### 2. Reply Token å–®æ¬¡ä½¿ç”¨

**é™åˆ¶**ï¼šLINE Reply Token åªèƒ½ä½¿ç”¨ä¸€æ¬¡

**è¨­è¨ˆåŸå‰‡**ï¼š
```javascript
// âŒ éŒ¯èª¤åšæ³•
await client.replyMessage(token, { text: 'åˆ†æä¸­...' });
// ... åˆ†æ ...
await client.replyMessage(token, flexMessage); // æœƒå¤±æ•—ï¼

// âœ… æ­£ç¢ºåšæ³•
// ... å®Œæ•´åˆ†æ ...
await client.replyMessage(token, flexMessage); // ä¸€æ¬¡å›è¦†
```

### 3. éŒ¯èª¤è™•ç†

**å¤šå±¤é˜²è­·**ï¼š
```javascript
try {
  // ä¸»æµç¨‹
} catch (error) {
  // å›è¦†å‹å–„éŒ¯èª¤è¨Šæ¯
  await client.replyMessage(token, {
    text: `âŒ æŸ¥è©¢å¤±æ•—\n\n${error.message}`
  });
}
```

**é™ç´šç­–ç•¥**ï¼š
- DeepSeek å¤±æ•— â†’ ä»å›è¦†æŠ€è¡“æŒ‡æ¨™
- åœ–è¡¨ç”Ÿæˆå¤±æ•— â†’ å›è¦†ç´”æ–‡å­—åˆ†æ
- FinMind å¤±æ•— â†’ å›è¦†éŒ¯èª¤è¨Šæ¯

## âš¡ æ•ˆèƒ½å„ªåŒ–

### 1. å¿«å–ç­–ç•¥

**12 å°æ™‚å¿«å–**ï¼š
- é¦–æ¬¡æŸ¥è©¢ï¼š15-25 ç§’
- å¿«å–æŸ¥è©¢ï¼š1-2 ç§’
- ç¯€çœ 90% ä»¥ä¸Šçš„è™•ç†æ™‚é–“

**å¿«å–å…§å®¹**ï¼š
```json
{
  "stock_id": "2330",
  "result_json": {
    "stock_info": {...},
    "latest_data": {...},
    "kd_analysis": {...},
    "macd_analysis": {...},
    "ai_result": {...}
  },
  "image_url": "https://...",
  "result_summary": "...",
  "updated_at": "2024-01-01T12:00:00Z"
}
```

### 2. ä¸¦è¡Œè™•ç†

```javascript
// åŒæ™‚æŠ“å–è‚¡åƒ¹å’Œè³‡è¨Š
const [stockData, stockInfo] = await Promise.all([
  fetchStockPrice(stockId),
  fetchStockInfo(stockId)
]);
```

### 3. è³‡æ–™é‡æ§åˆ¶

- æŠ“å–ï¼š365 å¤©è³‡æ–™ï¼ˆå®Œæ•´è¨ˆç®—ï¼‰
- é¡¯ç¤ºï¼š60 å¤©è³‡æ–™ï¼ˆé¿å…åœ–è¡¨æ“æ“ ï¼‰
- AI åˆ†æï¼š40 å¤©è³‡æ–™ï¼ˆè¶³å¤ é æ¸¬ï¼‰

## ğŸ“ˆ æ“´å±•æ€§è¨­è¨ˆ

### æ°´å¹³æ“´å±•

- âœ… Serverless æ¶æ§‹ï¼ˆNetlify è‡ªå‹•æ“´å±•ï¼‰
- âœ… ç„¡ç‹€æ…‹è¨­è¨ˆï¼ˆæ¯æ¬¡è«‹æ±‚ç¨ç«‹ï¼‰
- âœ… è³‡æ–™åº«é€£ç·šæ± ï¼ˆSupabase ç®¡ç†ï¼‰

### å‚ç›´æ“´å±•

- å¯å¢åŠ æ›´å¤šæŠ€è¡“æŒ‡æ¨™ï¼ˆRSIã€å¸ƒæ—é€šé“ç­‰ï¼‰
- å¯æ”¯æ´æ›´å¤šå¸‚å ´ï¼ˆç¾è‚¡ã€æ¸¯è‚¡ç­‰ï¼‰
- å¯åŠ å…¥æ›´å¤š AI æ¨¡å‹ï¼ˆGPTã€Claude ç­‰ï¼‰

### ç›£æ§èˆ‡æ—¥èªŒ

```javascript
console.log(`ğŸ“Š æŠ“å– FinMind è³‡æ–™ï¼š${stockId}`);
console.log(`âœ… æˆåŠŸæŠ“å– ${data.length} ç­†è³‡æ–™`);
console.log(`ğŸ¤– é–‹å§‹ DeepSeek AI åˆ†æï¼š${stockId}`);
console.log(`âœ… åˆ†æå®Œæˆä¸¦å·²å›è¦†`);
```

## ğŸ¯ è¨­è¨ˆåŸå‰‡

1. **å–®ä¸€è·è²¬**ï¼šæ¯å€‹æ¨¡çµ„åªè² è²¬ä¸€ä»¶äº‹
2. **ä¾è³´æ³¨å…¥**ï¼šæ¨¡çµ„é–“ä½è€¦åˆ
3. **éŒ¯èª¤å®¹éŒ¯**ï¼šå¤±æ•—ä¸å½±éŸ¿ä¸»æµç¨‹
4. **æ•ˆèƒ½å„ªå…ˆ**ï¼šå¿«å–ã€ä¸¦è¡Œã€é™ç´š
5. **å®‰å…¨ç¬¬ä¸€**ï¼šå»é‡ã€é©—è­‰ã€é™æµ

## ğŸ“Š è³‡æ–™è¡¨è¨­è¨ˆ

### line_eventsï¼ˆå»é‡è¡¨ï¼‰

```sql
CREATE TABLE line_events (
  id BIGSERIAL PRIMARY KEY,
  reply_token TEXT UNIQUE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**ç”¨é€”**ï¼šé˜²æ­¢ Webhook é‡è¤‡è§¸ç™¼

### stock_cacheï¼ˆå¿«å–è¡¨ï¼‰

```sql
CREATE TABLE stock_cache (
  stock_id TEXT PRIMARY KEY,
  result_json JSONB,
  image_url TEXT,
  image_path TEXT,
  result_summary TEXT,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**ç”¨é€”**ï¼š12 å°æ™‚å¿«å–æ©Ÿåˆ¶

## ğŸ”„ æœªä¾†å„ªåŒ–æ–¹å‘

1. **Redis å¿«å–**ï¼šæ›´å¿«çš„å¿«å–å­˜å–
2. **WebSocket**ï¼šå³æ™‚æ¨é€åˆ†æé€²åº¦
3. **æ‰¹æ¬¡è™•ç†**ï¼šæ”¯æ´å¤šè‚¡ç¥¨åŒæ™‚æŸ¥è©¢
4. **ä½¿ç”¨è€…åå¥½**ï¼šè¨˜ä½ä½¿ç”¨è€…å¸¸æŸ¥è‚¡ç¥¨
5. **é€šçŸ¥åŠŸèƒ½**ï¼šåƒ¹æ ¼çªç ´ã€æŒ‡æ¨™è½‰æŠ˜é€šçŸ¥
6. **æ­·å²è¨˜éŒ„**ï¼šæŸ¥è©¢æ­·å²èˆ‡çµ±è¨ˆ
7. **ç¤¾ç¾¤åŠŸèƒ½**ï¼šç†±é–€è‚¡ç¥¨æ’è¡Œ
8. **é€²éšåˆ†æ**ï¼šæ›´å¤šæŠ€è¡“æŒ‡æ¨™ã€å‹æ…‹è¾¨è­˜

---

**è¨­è¨ˆç†å¿µ**ï¼šç°¡å–®ã€å¿«é€Ÿã€å¯é ã€å¯æ“´å±•

