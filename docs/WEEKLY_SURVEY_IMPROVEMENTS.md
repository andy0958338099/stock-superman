# 每週問卷調查系統改進

## 🎯 改進目標

解決以下問題：
1. ✅ **自動初始化新週** - 不需要手動觸發，系統自動檢測並初始化
2. ✅ **顯示上週結果** - 用戶可以看到上週的最終評分結果
3. ✅ **清晰的投票狀態** - 明確顯示本週是否已投票，以及本週投票進度
4. ✅ **週期自動切換** - 每週一自動切換到新週，用戶可以重新投票

## 📊 改進內容

### 1. 自動初始化新週

#### 新增檔案：`functions/auto-init-week.js`

**功能**：
- 自動檢測當前週是否已初始化
- 如果檢測到新週，自動創建新的週別記錄
- 將上週設為非活動狀態

**觸發時機**：
- 每次用戶查詢問卷時自動檢查
- 無需手動觸發或定時任務

**實作邏輯**：
```javascript
// 檢查當前活動週是否為本週
if (currentWeek.week_number !== thisWeekNumber) {
  // 自動初始化新週
  await initializeNewWeek();
}
```

### 2. 顯示上週結果

#### 修改檔案：`functions/survey-handler.js`

**新增函數**：
- `getLastWeekStatistics()` - 取得上週的統計資訊
- `getFullSurveyInfo()` - 取得完整資訊（本週 + 上週）

**資料結構**：
```javascript
{
  currentWeek: { id, week_number, start_date, end_date, ... },
  currentStatistics: { total_votes, average_score, ... },
  lastWeek: { id, week_number, start_date, end_date, ... },
  lastStatistics: { total_votes, average_score, ... }
}
```

### 3. 改進 Flex Message 顯示

#### 修改檔案：`functions/survey-flex-message.js`

**顯示邏輯改進**：

**之前**：
- 只顯示「本週評分統計」
- 混淆了「本週投票」和「上週結果」

**現在**：
- **上週結果區塊**（如果有）
  - 顯示上週日期範圍
  - 顯示上週平均分數和投票人數
  - 顯示信心指數和評價
  - 顯示分數分布圖表
  
- **本週投票區塊**
  - 顯示本週日期範圍
  - 顯示投票狀態（已投票/未投票）
  - 顯示本週已投票人數
  - 提供投票按鈕（如果未投票）

### 4. 更新 Webhook 處理

#### 修改檔案：`functions/line-webhook.js`

**改進點**：
- 使用 `getFullSurveyInfo()` 取得完整資訊
- 傳遞本週和上週資料到 Flex Message
- 自動觸發週別檢查

## 🔄 工作流程

### 用戶查詢問卷時

```
1. 用戶發送「問卷」或「評分」
   ↓
2. 系統自動檢查週別
   ├─ 如果是新週 → 自動初始化
   └─ 如果是當前週 → 繼續
   ↓
3. 取得完整資訊
   ├─ 本週資訊和統計
   └─ 上週資訊和統計
   ↓
4. 檢查用戶是否已投票
   ↓
5. 生成 Flex Message
   ├─ 顯示上週結果（如果有）
   ├─ 顯示本週投票狀態
   └─ 提供投票按鈕（如果未投票）
   ↓
6. 發送訊息給用戶
```

### 用戶投票時

```
1. 用戶點擊評分按鈕（1-5 分）
   ↓
2. 系統檢查是否已投票
   ├─ 已投票 → 返回錯誤訊息
   └─ 未投票 → 繼續
   ↓
3. 記錄投票到資料庫
   ├─ survey_votes 表
   └─ 觸發器自動更新 survey_statistics
   ↓
4. 取得更新後的統計
   ↓
5. 發送成功訊息和更新後的問卷
```

### 週一自動切換

```
週一 00:00
   ↓
用戶首次查詢問卷
   ↓
系統檢測到新週
   ├─ 將上週設為 is_active = false
   ├─ 創建新週記錄 is_active = true
   └─ 記錄週別編號、日期範圍
   ↓
用戶可以重新投票
```

## 📱 用戶體驗改進

### 之前的問題

❌ 不知道上週的最終結果
❌ 不清楚本週是否已投票
❌ 新週需要手動初始化
❌ 顯示資訊混亂

### 現在的體驗

✅ **清晰的資訊層次**
```
📋 上週結果公佈
   11/18 ~ 11/24
   平均分數：4.2 / 5.0
   投票人數：15 人
   高度可信 (84%)
   [分數分布圖表]

─────────────────

🗳️ 請為上週的分析評分
   本週：11/25 ~ 12/1
   本週已有 3 人投票
   [評分按鈕 1-5]
```

✅ **自動週期管理**
- 週一自動切換到新週
- 用戶可以重新投票
- 無需管理員手動操作

✅ **即時反饋**
- 投票後立即看到更新的統計
- 顯示本週投票進度

## 🔧 技術細節

### 資料庫結構

**survey_weeks** - 週別定義表
```sql
id | week_number | year | week_of_year | start_date | end_date | is_active
1  | 202447      | 2024 | 47           | 2024-11-18 | 2024-11-24 | false
2  | 202448      | 2024 | 48           | 2024-11-25 | 2024-12-01 | true
```

**survey_votes** - 投票記錄表
```sql
id | user_id | week_id | score | voted_at
1  | U123... | 1       | 5     | 2024-11-20 10:30:00
2  | U456... | 1       | 4     | 2024-11-21 14:15:00
3  | U123... | 2       | 4     | 2024-11-25 09:00:00  ← 新週可以重新投票
```

**survey_statistics** - 統計表（自動更新）
```sql
id | week_id | total_votes | average_score | score_5_count | ...
1  | 1       | 15          | 4.20          | 8             | ...
2  | 2       | 3           | 4.33          | 2             | ...
```

### 週別計算

使用 **ISO 8601 週數標準**：
- 週一為一週的開始
- 每年第一個包含週四的週為第 1 週
- 確保跨年週數計算正確

## 🚀 部署和測試

### 部署

代碼已推送到 GitHub，Netlify 會自動部署。

### 測試步驟

1. **測試自動初始化**
   ```
   發送：問卷
   預期：顯示當前週的問卷（自動初始化）
   ```

2. **測試投票**
   ```
   點擊：評分按鈕（例如 5 分）
   預期：投票成功，顯示更新後的統計
   ```

3. **測試重複投票**
   ```
   再次點擊：評分按鈕
   預期：提示「您本週已經投票過了」
   ```

4. **測試週一切換**（需要等到週一）
   ```
   週一發送：問卷
   預期：
   - 顯示上週結果
   - 可以重新投票
   - 本週投票數為 0
   ```

## 📝 後續改進建議

- [ ] 添加推播通知（週一提醒用戶投票）
- [ ] 添加歷史趨勢圖表（過去 4 週的評分變化）
- [ ] 添加評論功能（用戶可以留言說明評分原因）
- [ ] 添加管理後台（查看詳細統計和用戶反饋）

