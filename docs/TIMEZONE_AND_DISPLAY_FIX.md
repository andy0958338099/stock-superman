# 時區修正和顯示順序優化

## 🎯 修正內容

### 1. ✅ 時區問題修正

**問題**：
- 系統使用 UTC 時間，與台北時間（UTC+8）有 8 小時時差
- 導致週別計算不正確（例如：台北時間週一 00:00，但系統仍認為是週日）
- 日期顯示不符合台灣用戶習慣

**解決方案**：
- 新增 `getTaipeiTime()` 函數，統一使用台北時間
- 修改所有週別計算和日期處理邏輯
- 確保週一 00:00（台北時間）正確切換到新週

**修改檔案**：
1. `functions/auto-init-week.js`
2. `functions/weekly-survey-update.js`

### 2. ✅ 顯示順序優化

**問題**：
- 用戶未投票時，上週結果顯示在下方
- 用戶更關心上週的最終結果，但需要往下滾動才能看到

**解決方案**：
- **未投票時**：上週結果顯示在最上面，本週問卷顯示在下方
- **已投票時**：保持原有順序（本週問卷在上，上週結果在下）

**修改檔案**：
1. `functions/survey-flex-message.js`

## 📱 用戶體驗改進

### 未投票時的顯示順序

```
┌─────────────────────────────────┐
│ 📋 上週結果公佈                  │ ← 最上面
│ 11/17 ~ 11/23                   │
│                                 │
│ 平均分數：5.00                   │
│ 投票人數：2 人                   │
│ 高度可信 (100%)                  │
│ [分數分布圖表]                   │
├─────────────────────────────────┤
│ 📊 每週問卷調查                  │ ← 下方
│ 本週：11/24 ~ 11/30             │
│                                 │
│ 🗳️ 請為上週的分析評分            │
│ [評分按鈕 1-5]                   │
└─────────────────────────────────┘
```

### 已投票時的顯示順序

```
┌─────────────────────────────────┐
│ 📊 每週問卷調查                  │ ← 最上面
│ 本週：11/24 ~ 11/30             │
├─────────────────────────────────┤
│ 📋 上週結果公佈                  │
│ 11/17 ~ 11/23                   │
│ [統計資訊]                       │
├─────────────────────────────────┤
│ ✅ 您本週已投票                  │
│ 感謝您的反饋！                   │
└─────────────────────────────────┘
```

## 🕐 時區處理細節

### getTaipeiTime() 函數

```javascript
function getTaipeiTime() {
  const now = new Date();
  // 轉換為台北時間（UTC+8）
  const taipeiTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));
  return taipeiTime;
}
```

### 使用範例

**之前**：
```javascript
const now = new Date(); // UTC 時間
const year = now.getFullYear();
```

**現在**：
```javascript
const now = getTaipeiTime(); // 台北時間
const year = now.getFullYear();
console.log(`🕐 當前台北時間：${now.toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })}`);
```

## 🔍 時區影響範圍

### 1. 週別計算
- **影響**：決定當前是第幾週
- **修正**：使用台北時間計算週數
- **檔案**：`auto-init-week.js`, `weekly-survey-update.js`

### 2. 週一判斷
- **影響**：決定何時切換到新週
- **修正**：台北時間週一 00:00 切換
- **檔案**：`auto-init-week.js`

### 3. 日期顯示
- **影響**：用戶看到的日期範圍
- **修正**：使用台北時間計算週一和週日
- **檔案**：`auto-init-week.js`, `weekly-survey-update.js`

## 📊 測試案例

### 測試 1：時區正確性

**場景**：台北時間週一 00:00
```
預期行為：
- 系統檢測到新週
- 自動初始化新週
- 用戶可以重新投票
```

**驗證方法**：
```javascript
console.log(`🕐 當前台北時間：${now.toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })}`);
console.log(`📅 週別編號：${weekNumber} (${year} 年第 ${weekOfYear} 週)`);
```

### 測試 2：顯示順序

**場景 A**：用戶未投票
```
預期顯示：
1. 上週結果公佈（最上面）
2. 每週問卷調查（下方）
3. 評分按鈕
```

**場景 B**：用戶已投票
```
預期顯示：
1. 每週問卷調查（最上面）
2. 上週結果公佈（下方）
3. 已投票提示
```

## 🚀 部署狀態

**Commit**: `141c964` - "Fix: Use Taipei timezone and reorder survey display (show last week results first when not voted)"

**變更檔案**：
- ✅ `functions/auto-init-week.js` - 新增 `getTaipeiTime()`，使用台北時間
- ✅ `functions/survey-flex-message.js` - 優化顯示順序邏輯
- ✅ `functions/weekly-survey-update.js` - 新增 `getTaipeiTime()`，使用台北時間

**部署時間**：約 2-3 分鐘

## 🧪 驗證步驟

### 1. 驗證時區
```
發送：問卷
查看 Netlify Function Logs：
- 應該顯示正確的台北時間
- 應該顯示正確的週別編號
```

### 2. 驗證顯示順序（未投票）
```
發送：問卷
預期：
- 最上面顯示「📋 上週結果公佈」
- 下方顯示「📊 每週問卷調查」
- 有評分按鈕
```

### 3. 驗證顯示順序（已投票）
```
投票後再發送：問卷
預期：
- 最上面顯示「📊 每週問卷調查」
- 下方顯示「📋 上週結果公佈」
- 顯示「✅ 您本週已投票」
```

### 4. 驗證週一切換
```
等到下週一（台北時間）
發送：問卷
預期：
- 自動初始化新週
- 可以重新投票
- 顯示上週的最終結果
```

## 📝 注意事項

1. **時區一致性**：所有時間相關的操作都應使用 `getTaipeiTime()`
2. **日誌記錄**：已添加台北時間和週別編號的日誌，方便除錯
3. **向後兼容**：不影響現有的投票記錄和統計資料
4. **效能影響**：時區轉換對效能影響極小（< 1ms）

## 🎉 改進效果

### 時區修正
- ✅ 週別計算正確（使用台北時間）
- ✅ 週一 00:00 正確切換到新週
- ✅ 日期顯示符合台灣用戶習慣

### 顯示優化
- ✅ 未投票時，上週結果優先顯示
- ✅ 已投票時，本週問卷優先顯示
- ✅ 資訊層次更清晰，用戶體驗更好

