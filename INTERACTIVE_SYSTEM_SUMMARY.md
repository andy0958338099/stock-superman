# 🎯 互動式股票分析系統 - 功能總結

## 📅 完成時間：2025-11-19

---

## 🌟 系統概述

這是一個基於 LINE Bot 的互動式股票分析系統，提供深度的多維度分析功能。用戶可以透過 Quick Reply 按鈕，逐步探索股票的技術面、新聞面、政治面、美股關聯，並與 AI 進行討論，最終獲得綜合總評。

---

## 🎨 用戶體驗流程

```
用戶輸入股票代號（例如：2330）
    ↓
收到技術分析 Flex Message
    ↓
看到 5 個 Quick Reply 按鈕
    ↓
┌─────────────────────────────────────┐
│ 📰 新聞 │ 🌍 政治 │ 🇺🇸 美股 │ 💬 討論 │ 📊 總評 │
└─────────────────────────────────────┘
    ↓
點擊任一按鈕進入深度分析
    ↓
可以繼續探索其他分析
    ↓
點擊「總評」獲得綜合建議
    ↓
評價總評（好/不好）
```

---

## 🔥 核心功能

### 1. 📰 新聞分析（限用 1 次）
- **功能**：搜尋 6 則最新財經新聞
- **AI 角色**：財經專家
- **分析風格**：唯恐天下不亂但不違背事實
- **輸出**：新聞對股價的潛在影響、關鍵風險和機會

### 2. 🌍 政治分析（限用 1 次）
- **功能**：搜尋 6 則國際情勢新聞
- **AI 角色**：政治評論員
- **分析風格**：語不驚人死不休但不違背事實
- **輸出**：地緣政治對產業的影響、風險評估

### 3. 🇺🇸 美股關聯分析（無限制）
- **功能**：分析美股與該股票的關聯性
- **AI 角色**：美股狂熱評論員
- **分析風格**：熱情但基於數據
- **輸出**：美股走勢對該股票的影響、產業鏈連動

### 4. 💬 討論功能（最多 5 次）
- **功能**：用戶提出看法，AI 分析論點
- **AI 角色**：理性經濟分析師
- **分析風格**：中性質疑、風險提醒
- **輸出**：論點合理性評估、盲點指出、風險提醒

### 5. 📊 綜合總評（無限制）
- **功能**：綜合所有分析生成總評
- **AI 角色**：資深投資顧問
- **分析風格**：勇敢且有決心
- **輸出**：
  - 摘要
  - 技術面總結
  - 基本面總結
  - 風險評估
  - 機會評估
  - 最終結論
  - 投資建議（買入/持有/賣出/觀望）
  - 目標價區間
  - 停損價位
  - 操作建議

---

## 🏗️ 技術架構

### 前端（LINE Bot）
- Quick Reply 按鈕
- Flex Message 技術分析
- 對話式互動

### 後端（Netlify Functions）
- `line-webhook.js` - 主處理器
- `google-search.js` - 新聞搜尋
- `conversation-state.js` - 狀態管理
- `deepseek.js` - AI 分析（5 種角色）
- `handlers/*.js` - 5 個功能處理器

### 資料庫（Supabase）
- `user_conversation_state` - 對話狀態
- `stock_final_reviews` - 總評（維基百科式）
- `user_review_votes` - 用戶評價

### 外部 API
- **FinMind API** - 台股/美股數據
- **Google Custom Search API** - 新聞搜尋
- **DeepSeek API** - AI 分析

---

## 🎭 DeepSeek AI 角色設計

| 功能 | AI 角色 | 個性特點 | Temperature |
|------|---------|----------|-------------|
| 新聞分析 | 財經專家 | 唯恐天下不亂但基於事實 | 0.8 |
| 政治分析 | 政治評論員 | 語不驚人死不休但基於事實 | 0.8 |
| 美股分析 | 美股狂熱評論員 | 熱情但基於數據 | 0.8 |
| 討論分析 | 理性經濟分析師 | 中性質疑、風險提醒 | 0.7 |
| 綜合總評 | 資深投資顧問 | 勇敢且有決心 | 0.7 |

---

## 🔒 功能限制機制

| 功能 | 限制 | 實作方式 |
|------|------|----------|
| 新聞分析 | 1 次 | `news_used` 標記 |
| 政治分析 | 1 次 | `politics_used` 標記 |
| 美股分析 | 無限制 | 無限制 |
| 討論 | 5 次 | `discussion_count` 計數器 |
| 總評 | 無限制 | 無限制 |

---

## 📊 資料流程

### 1. 股票查詢
```
用戶輸入 2330
    ↓
檢查快取（6 小時）
    ↓
抓取股價數據（FinMind API）
    ↓
生成技術指標圖表
    ↓
DeepSeek 技術分析
    ↓
儲存快取
    ↓
初始化對話狀態
    ↓
回覆 Flex Message + Quick Reply
```

### 2. 新聞分析
```
用戶點擊「新聞」
    ↓
檢查功能可用性
    ↓
Google Search API 搜尋 6 則新聞
    ↓
DeepSeek 財經專家分析
    ↓
標記 news_used = true
    ↓
儲存分析內容到狀態
    ↓
回覆分析結果 + 更新 Quick Reply
```

### 3. 討論功能
```
用戶點擊「討論」
    ↓
檢查討論次數 < 5
    ↓
設定狀態為 discussion_waiting
    ↓
提示用戶輸入意見
    ↓
用戶輸入意見
    ↓
DeepSeek 分析論點
    ↓
discussion_count + 1
    ↓
儲存討論歷史
    ↓
回覆分析 + 更新 Quick Reply
```

### 4. 綜合總評
```
用戶點擊「總評」
    ↓
收集所有分析數據
    ↓
取得先前總評（如果有）
    ↓
DeepSeek 生成綜合總評
    ↓
儲存到 stock_final_reviews
    ↓
回覆總評 + 評價按鈕
    ↓
用戶評價（好/不好）
    ↓
記錄到 user_review_votes
    ↓
自動更新統計
```

---

## 🎯 關鍵創新點

1. **防止 ReplyToken 錯誤**
   - 使用對話狀態管理
   - Quick Reply 攜帶資訊
   - 每次都是新的 replyToken

2. **維基百科式總評**
   - 結構化內容儲存
   - 版本控制
   - 用戶評價系統

3. **多角色 AI 分析**
   - 5 種不同個性的 AI 角色
   - 針對不同場景調整 Temperature
   - 提供多維度洞察

4. **智慧功能限制**
   - 新聞/政治限用 1 次（避免 API 浪費）
   - 討論限用 5 次（避免無限對話）
   - 動態顯示/隱藏按鈕

---

## 📈 預期效果

- **用戶參與度**：從單次查詢提升到多次互動
- **分析深度**：從技術面擴展到多維度分析
- **決策支援**：提供更全面的投資建議
- **用戶黏性**：討論和評價機制增加互動

---

**🎉 系統開發完成，準備部署！**

