# 管理者功能設定指南

## 📋 概述

股市大亨 LINE Bot 提供隱藏的管理者功能，用於管理快取資料。只有設定為管理者的用戶才能使用這些指令。

---

## 🔧 管理者指令列表

### 1. **刪除所有快取**
```
清除快取
```
或
```
刪除快取
```
或
```
clear cache
```

**功能**：刪除資料庫中所有股票的快取資料

**使用時機**：
- 圖表生成出現問題，需要清除所有無效快取
- 系統更新後，需要重新生成所有圖表
- 定期清理過期資料

---

### 2. **刪除特定股票快取**
```
刪除快取 2330
```
或
```
清除快取 3003
```
或
```
delete cache 2454
```

**功能**：刪除指定股票代號的快取資料

**使用時機**：
- 某支股票的圖表顯示錯誤
- 需要強制重新生成特定股票的分析

---

## 🔑 如何設定管理者權限

### 步驟 1：獲取你的 LINE User ID

有兩種方法可以獲取你的 LINE User ID：

#### 方法 A：從 Netlify 日誌查看

1. 在 LINE 中向 Bot 發送任何訊息（例如：`2330`）
2. 前往 Netlify Dashboard
3. 點擊 **Functions** → **line-webhook**
4. 查看最新的日誌，找到類似這樣的訊息：
   ```
   📝 收到訊息：2330 (User: U1234567890abcdef1234567890abcdef)
   ```
5. 複製 `User:` 後面的那串 ID（以 `U` 開頭）

#### 方法 B：使用 LINE Developers Console

1. 前往 [LINE Developers Console](https://developers.line.biz/console/)
2. 選擇你的 Provider 和 Channel
3. 點擊 **Messaging API** 標籤
4. 向下滾動找到 **Your user ID**
5. 複製顯示的 User ID

---

### 步驟 2：設定環境變數

#### 在 Netlify 設定：

1. 前往 Netlify Dashboard
2. 選擇你的專案（Stock-Superman）
3. 點擊 **Site configuration** → **Environment variables**
4. 點擊 **Add a variable**
5. 設定：
   - **Key**: `LINE_ADMIN_USER_ID`
   - **Value**: 你的 LINE User ID（例如：`U1234567890abcdef1234567890abcdef`）
6. 點擊 **Save**
7. 重新部署網站（Netlify 會自動觸發）

#### 在本地 .env 檔案設定（可選）：

如果你需要在本地測試，編輯 `.env` 檔案：

```bash
LINE_ADMIN_USER_ID=U1234567890abcdef1234567890abcdef
```

---

### 步驟 3：測試管理者功能

1. 等待 Netlify 部署完成（約 2-3 分鐘）
2. 在 LINE 中向 Bot 發送：`清除快取`
3. 如果設定成功，你會收到類似這樣的回覆：
   ```
   🔧 管理者指令執行完成
   
   已刪除所有快取（5 筆）
   ```

---

## 🔒 安全性說明

### 為什麼這是安全的？

1. **隱藏指令**：管理者指令不會出現在任何用戶介面或說明中
2. **身份驗證**：只有 `LINE_ADMIN_USER_ID` 環境變數中設定的用戶才能執行
3. **無提示**：一般用戶輸入管理者指令時，Bot 會當作無效輸入處理
4. **日誌記錄**：所有管理者指令執行都會記錄在 Netlify 日誌中

### 注意事項

- ⚠️ **不要分享你的 User ID**：這是你的唯一識別碼
- ⚠️ **不要將 .env 檔案提交到 Git**：已在 `.gitignore` 中排除
- ⚠️ **定期檢查日誌**：確保沒有未授權的管理者指令執行

---

## 📊 快取管理最佳實踐

### 何時應該清除快取？

1. **圖表顯示錯誤**
   - 圖片無法載入
   - 圖表資料不正確
   - 圖表格式異常

2. **系統更新後**
   - 修改了圖表生成邏輯
   - 更新了技術指標計算方式
   - 變更了 Flex Message 格式

3. **定期維護**
   - 建議每週清除一次所有快取
   - 確保用戶獲得最新的分析結果

### 清除快取的影響

- ✅ **優點**：
  - 強制重新生成所有圖表
  - 清除無效或損壞的快取
  - 釋放資料庫空間

- ⚠️ **缺點**：
  - 清除後首次查詢會較慢（需要重新生成）
  - 增加 API 呼叫次數（FinMind、QuickChart）

---

## 🐛 故障排除

### 問題 1：輸入「清除快取」沒有反應

**可能原因**：
- User ID 設定錯誤
- 環境變數未生效

**解決方法**：
1. 檢查 Netlify 環境變數是否正確設定
2. 確認 User ID 格式正確（以 `U` 開頭）
3. 重新部署網站
4. 查看 Netlify 日誌確認錯誤訊息

---

### 問題 2：收到「管理者指令執行完成」但快取未刪除

**可能原因**：
- Supabase 連線問題
- 資料庫權限不足

**解決方法**：
1. 檢查 Supabase 連線狀態
2. 確認 `SUPABASE_SERVICE_ROLE_KEY` 環境變數正確
3. 查看 Netlify Function 日誌

---

## 📝 範例使用情境

### 情境 1：某支股票圖表顯示錯誤

```
你：刪除快取 2330
Bot：🔧 管理者指令執行完成
     已刪除股票 2330 的快取（1 筆）

你：2330
Bot：[顯示重新生成的 2330 分析結果]
```

---

### 情境 2：系統更新後清除所有快取

```
你：清除快取
Bot：🔧 管理者指令執行完成
     已刪除所有快取（25 筆）
```

---

## 🎯 總結

管理者功能讓你能夠：
- ✅ 快速清除無效快取
- ✅ 強制重新生成圖表
- ✅ 維護系統資料品質
- ✅ 不影響一般用戶使用體驗

記得定期檢查和維護快取，確保用戶獲得最佳的使用體驗！

